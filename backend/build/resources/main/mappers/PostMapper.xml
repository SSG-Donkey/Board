<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.backend.mappers.PostMapper">

    <insert id="insertPost" parameterType="map" >
        INSERT INTO post (post_title, post_content, post_file, user_no,post_views ,post_category,region_no,post_status,point)
        VALUES (#{post_title}, #{post_content}, #{post_file}, #{user_no}, #{post_views},#{post_category},#{region_no},#{post_status},#{point})
    </insert>

    <select id="findAllPosts" parameterType="map" resultType="com.project.backend.dto.PostDto">
        SELECT * FROM post
        ORDER BY post_date DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="getTotalPostCount" resultType="int">
        SELECT COUNT(*) FROM posts
    </select>

    <select id="getRecentPost"  resultType="com.project.backend.dto.PostDto">
        SELECT *
        FROM (
            SELECT *,
            ROW_NUMBER() OVER (PARTITION BY post_category ORDER BY post_date DESC) as rn
            FROM post
        ) AS RankedPosts
        WHERE rn <![CDATA[<=]]> 3
    </select>

    <select id="findPostByTitle" parameterType="string" resultType="com.project.backend.dto.PostDto">
        SELECT * FROM post WHERE post_title = #{getPostTitle}
    </select>

    <select id="findPostByNo" parameterType="string" resultType="com.project.backend.dto.PostDto">
        SELECT *
        FROM post p
                 JOIN user u ON p.user_no = u.user_no
        WHERE post_no = #{getPostNo}
    </select>

    <select id="findPostByCategory" parameterType="string" resultType="com.project.backend.dto.PostDto">
        <!-- categoryNo null이 아닌 경우 -->
        <if test="categoryNo != null">
            SELECT * FROM post WHERE post_category = #{categoryNo}
        </if>
        <!-- categoryNo가 null인 경우 -->
        <if test="categoryNo == null">
            SELECT * FROM post
        </if>
    </select>

</mapper>
